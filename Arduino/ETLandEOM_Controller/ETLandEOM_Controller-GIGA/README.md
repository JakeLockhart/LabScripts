# ETL and EOM Controller
This project uses an Arduino Giga R1 Wifi board.
The Giga is used to send two outputs, one TTL pulse being sent to the ETL and one analog pulse being sent to an amplifyier and then the EOM.

## Hardware
The Giga has a voltage range of 0-3.3V and many more available pins (GPIO, Digital (PWM), Analog In, DAC0/1). The board has two microprocessors, the M7 core has a clock speed of 480MHz and the M4 core has a clock speed of 240MHz. For most applications, only the M7 core needs to be programmed. The voltage range for the DAC ports is 0-2V with a resolution of 0.8MV. This board can access wifi through an antenna... In otherwords, this board is extremely overquallified for the task of recieving and outputting signals to control the ETL and EOM. However, the DAC output range is appropriate for this project.

## Logic
- **Reference Tables**
Two references tables are included in this project, OscilloscopeVoltage.cpp and PowerResults.cpp. The OscilloscopeVoltage.cpp file contains the low signals and high signals that are created by MScan based on the input laser intensity percentage [%]. The PowerResults.cpp contains the output laser intensity [mW] with respect to the input laser intensity percentage [%]. These two files are used together with a linear interpolation (multiple files) to determine the signals needed to create a a specific laser intensity output for the microscope.
- **Input Parameters**
This section was designed so that the user only needs to edit this file to control the desired imaging plane depths and laser intensity power. It is separated into two sections: User Inputs and Do Not Edit. The 'User Inputs' section controls the user defined parameters and can be readily updated. The 'Do Not Edit' section includes board parameters that are necessary for the board to function and should not need to be modified. Specifically, items like PulseWidth and PulseGap have been tuned to ensure that created pulses do not occur during low signals output by MScan. It is unlikely that this section needs to be edited.
- **Input Signal Detection**
Input signals are currently generated by an Arduino Due to simulate signals created by MScan. Each pulse is detected based on the attachInterrupt() function. Signal detection is relatively straightforward.
- **Output Signal Creation**
The attachInterrupt() function is used to detect the rising edge of incoming pulses created by MScan. When a pulse is detected, the ISR function (FlagState.cpp) is called. This ISR simply turns a boolian Flag from false to true. Within the void loop() {}, the Flag is constantly monitored. Whenever the Flag is true, the CreatePulses.cpp function is called to output a digital and analog pulse based on the Reference Tables and Input Parameters.
The CreatePulses.cpp has two functions. First the analog pulse controls the EOM. Every pulse from MScan requires a single analog pulse from the Arduino so that each imaging plane is given power. The amplitude of each analog pulse is dependent on the image plane cycle. Second the digital pulse controls the ETL. 
## Notes
The generation of pulses is dependent on quickly detecting incoming signals and creating output signals. By using void loop() {} with a flag method for the ISR, it is possible to miss incoming signals and cause several timing issues. This means that the output pulse must be shorter than the incoming pulse. This is fine so long as the output pulse is centered in the incoming pulse. This means that the top and bottom edges of the imaging planes will not be given power, but this is acceptable so long as penetrating arterioles are still in focus.

## Future goals
NEED TO CHECK THIS!!!!
CURRENTLY A VOLTAGE STEP ONLY OCCURS WHENEVER AN ETL PULSE IS SENT. SHOULD EACH VOLTAGE STEP BE CONTAINED BETWEEN THE ETL PULSES? HOW DOES GARDASOFT CHANGE THE IMAGING PLANE?? IS IT ONE IMAGING PLANE CHANGE PER ETL PULSE OR IS IT (for 10 imaging planes) 10 IMAGE PLANE CHANGES PER ETL PULSE?